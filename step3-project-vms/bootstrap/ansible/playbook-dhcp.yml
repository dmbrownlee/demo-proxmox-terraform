---
- name: Configure DHCP
  hosts: all
  vars_files:
    - "{{ tf_workspace }}.vars.yml"
  become: true
  tasks:
    - name: Ensure the DHCP service is installed
      ansible.builtin.apt:
        name:
          - kea-dhcp4-server
        update_cache: yes
        cache_valid_time: 300
    - name: Ensure the DHCP service is enabled and started
      ansible.builtin.systemd:
        name: kea-dhcp4-server
        enabled: yes
        state: started
    - name: Ensure the DHCP service is configured
      ansible.builtin.template:
        dest: /etc/kea/{{ item }}
        src: "{{ item }}.j2"
        owner: root
        group: root
        mode: '0644'
      loop:
        - kea-dhcp4.conf
      register: dhcp4_config
    - name: Ensure the DHCP service is restarted if config has changed
      ansible.builtin.systemd:
        name: kea-dhcp4-server
        state: restarted
      when: dhcp4_config.changed
    # - name: Ensure the firewall allows traffic to the DHCP service
    #   ansible.posix.firewalld:
    #     zone: external
    #     service: "{{ item }}"
    #     permanent: yes
    #     immediate: yes
    #     state: enabled
    #   loop:
    #     - dhcp
    #     - dhcpv6
