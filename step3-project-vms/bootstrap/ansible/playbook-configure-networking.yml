
---
- name: Configure network interfaces
  hosts: all
  vars_files:
    - "{{ tf_workspace }}.vars.yml"
  become: true
  tasks:
    - name: Ensure the NetworkManager software is installed
      ansible.builtin.apt:
        name: network-manager
        update_cache: yes
        cache_valid_time: 300
    - name: Ensure the NetworkManager service is enabled and started
      ansible.builtin.systemd:
        name: NetworkManager
        enabled: yes
        state: started
    - name: Ensure the "Wired connection 1" connection has been removed
      community.general.nmcli:
        type: ethernet
        conn_name: "Wired connection 1" 
        state: absent
    - name: Ensure the "Wired connection 2" connection has been removed
      community.general.nmcli:
        type: ethernet
        conn_name: "Wired connection 2" 
        state: absent
    # - name: Ensure the "WAN" connection exists
    #   community.general.nmcli:
    #     type: ethernet
    #     conn_name: 'WAN'
    #     ifname: "{{ wan_interface }}"
    #     method4: auto
    #     # method4: manual
    #     # ip4: '10.48.16.51/24'
    #     # gw4: '10.48.16.254'
    #     zone: external
    #     state: present
    - name: Ensure the "LAN" connection exists
      community.general.nmcli:
        type: ethernet
        conn_name: 'LAN'
        ifname: "{{ lan_interface }}"
        method4: manual
        ip4: "{{ lan_address }}/{{ lan_prefix }}"
        zone: trusted
        state: present
    # - name: Ensure the "WAN" connection is activated
    #   community.general.nmcli:
    #     conn_name: 'WAN'
    #     state: up
    - name: Ensure the "LAN" connection is activated
      community.general.nmcli:
        conn_name: 'LAN'
        state: up
    # - name: Ensure routing between network interfaces is enabled
    #   ansible.posix.sysctl:
    #     name: net.ipv4.ip_forward
    #     value: 1
